version: 1.0.{build}
image: Visual Studio 2017
configuration: Release
platform: Any CPU

# Install Pester
init: 
    - cinst -y pester --force

install:

- ps: $psversiontable
- reg ADD "HKLM\Software\Microsoft\StrongName\Verification\Microsoft.PackageManagement.NuGetProvider,31bf3856ad364e35"  /f
- reg ADD "HKLM\Software\Wow6432Node\Microsoft\StrongName\Verification\Microsoft.PackageManagement.NuGetProvider,31bf3856ad364e35"  /f

before_build:
  - ps: .\Generate-Resources.ps1
  - ps: $null = Invoke-WebRequest https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -OutFile nuget.exe
  - ps: pushd .\vs-csproj
  - ps: & .\nuget.exe restore -PackagesDirectory (Join-Path $pwd vs-csproj\packages)
  - ps: popd
build_script:
  - msbuild "vs-csproj\NugetLightProvider.csproj" /verbosity:normal
after_build:
- ps: >-
    Get-ChildItem "C:\output\release\bin" -Recurse | ForEach-Object { Push-AppveyorArtifact $_.FullName -FileName $_.Name -DeploymentName releasebits -Type Auto }

before_test:
- ps: >-   
    # Import the Nuget provider just built
    Import-PackageProvider C:\output\release\bin\Microsoft.PackageManagement.NuGetProvider.dll -force -verbose
   
    & .\NuGetProvider\smoketest.tests.ps1
